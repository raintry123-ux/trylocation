<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - College System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .dashboard-content {
            padding: 40px;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            word-break: break-word;
        }
        
        .user-info h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .info-item {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .attendance-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .location-status {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .location-status.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
        }
        
        .location-status.error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        
        .location-status.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .attendance-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .today-attendance {
            background: #fff7ed;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .monthly-stats {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0f2fe;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0369a1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .action-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            border-color: #6a11cb;
        }
        
        .action-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .logout-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .logout-btn:hover {
            opacity: 0.9;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .attendance-record {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #10b981;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced location styles */
        .location-info {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .location-coordinates {
            font-family: monospace;
            background: #e2e8f0;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .accuracy-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .accuracy-good {
            background: #d1fae5;
            color: #065f46;
        }
        
        .accuracy-poor {
            background: #fef3c7;
            color: #92400e;
        }
        
        .accuracy-bad {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .fallback-option {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .fallback-btn {
            background: linear-gradient(to right, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        
        .fallback-btn:hover {
            opacity: 0.9;
        }
        
        .location-method {
            display: inline-block;
            padding: 2px 8px;
            background: #e0f2fe;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* small screen tweaks */
        @media (max-width: 480px) {
            .calendar { grid-auto-rows: 48px; }
            .calendar-day { padding: 6px; font-size: 12px; min-width: 48px; }
            .header h1 { font-size: 22px; }
            .dashboard-content { padding: 20px; }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Welcome to Dashboard</h1>
            <p>College Attendance System</p>
            <button class="admin-btn" id="adminPanelBtn" style="display: none;" onclick="openAdminPanel()">Admin Panel</button>
        </div>
        
        <!-- Regular User Dashboard -->
        <div class="dashboard-content" id="regularDashboard">
            <!-- User Information -->
            <div class="user-info">
                <h3>User Information</h3>
                <div class="info-item">
                    <strong>Email:</strong> <span id="userEmail">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Full Name:</strong> <span id="userName">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Phone:</strong> <span id="userPhone">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>User ID:</strong> <span id="userId">Loading...</span>
                </div>
            </div>
            
            <!-- Enhanced Automatic Attendance Section -->
            <div class="attendance-section">
                <h3>Smart Attendance System</h3>
                <p>Multiple methods used to ensure accurate location detection</p>
                
                <div id="locationStatus" class="location-status">
                    <div class="loading"></div> Starting enhanced location detection...
                </div>
                
                <div class="location-info">
                    <p><strong>College Location:</strong></p>
                    <div class="location-coordinates">Latitude: 21.734479, Longitude: 70.438623</div>
                    <p><strong>City:</strong> Amreli, Gujarat, India</p>
                    <p><strong>Acceptable Range:</strong> Within 500 meters radius</p>
                </div>
                
                <div id="attendanceStatus" class="attendance-status"></div>
                
                <div id="todayAttendance" class="today-attendance" style="display: none;">
                    <h4>Today's Attendance</h4>
                    <p><strong>Time:</strong> <span id="attendanceTime"></span></p>
                    <p><strong>Date:</strong> <span id="attendanceDate"></span></p>
                    <p><strong>Status:</strong> <span style="color: green;">Present ‚úÖ</span></p>
                    <p><strong>Location Method:</strong> <span id="attendanceMethod"></span></p>
                </div>

                <!-- Enhanced Fallback Options -->
                <div class="fallback-option" id="fallbackOption" style="display: none;">
                    <h4>üîß Location Accuracy Options</h4>
                    <p>If automatic detection fails, try these methods:</p>
                    <button class="fallback-btn" onclick="useHighAccuracyGPS()">High Accuracy GPS</button>
                    <button class="fallback-btn" onclick="useIPLocation()">IP Location</button>
                    <button class="fallback-btn" onclick="markAttendanceWithVerification()">Verify & Mark</button>
                </div>

                <!-- Monthly Statistics -->
                <div class="monthly-stats">
                    <h4>üìä This Month's Attendance</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="monthWorkingDays">0</div>
                            <div class="stat-label">Working Days</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthPresent">0</div>
                            <div class="stat-label">Present</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthAbsent">0</div>
                            <div class="stat-label">Absent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthPercentage">0%</div>
                            <div class="stat-label">Percentage</div>
                        </div>
                    </div>
                    
                    <!-- Monthly Calendar View -->
                    <div id="monthCalendar" style="margin-top: 20px;" class="calendar-wrapper"></div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="actions">
                <div class="action-card" onclick="viewProfile()">
                    <div class="action-icon">üë§</div>
                    <h3>View Profile</h3>
                    <p>Check your personal information</p>
                </div>
                
                <div class="action-card" onclick="viewAttendanceRecords()">
                    <div class="action-icon">üìä</div>
                    <h3>Attendance Records</h3>
                    <p>View your attendance history</p>
                </div>
                
                <div class="action-card" onclick="refreshLocation()">
                    <div class="action-icon">üîÑ</div>
                    <h3>Refresh Location</h3>
                    <p>Retry location detection</p>
                </div>
            </div>
            
            <center>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </center>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAn2MiKH9C3CXd_UBFvgy_8rxiENBsiJpc",
            authDomain: "rainweblogin-pagedatabase.firebaseapp.com",
            projectId: "rainweblogin-pagedatabase",
            storageBucket: "rainweblogin-pagedatabase.firebasestorage.app",
            messagingSenderId: "205913357514",
            appId: "1:205913357514:web:d83813940596f85e3c4833",
            measurementId: "G-1LZD8HGKDP"
        };

        // Initialize Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Global variables
        let currentUser = null;
        let userData = null;
        let allAttendanceRecords = [];
        let isAdminUser = false;
        let attendanceMarkedToday = false;
        let locationWatchId = null;

        // College location - Amreli
        const COLLEGE_LOCATION = {
            latitude: 21.734479,
            longitude: 70.438623,
            city: "Amreli",
            region: "Gujarat",
            country: "India"
        };

        // Enhanced location detection with multiple attempts
        const ACCURACY_THRESHOLD = 50; // meters
        const DISTANCE_THRESHOLD = 500; // meters
        const MAX_ATTEMPTS = 5;

        // Check if user is logged in and load data
        window.addEventListener('load', async function() {
            try {
                currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            } catch (err) {
                currentUser = null;
            }
            
            if (!currentUser || !currentUser.email || !currentUser.uid) {
                window.location.href = 'index.html';
                return;
            }

            // Display basic user info
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userId').textContent = currentUser.uid || 'N/A';

            // Load user data from Firestore
            await loadUserData();
            
            // Check if user is admin
            await checkAdminStatus();
            
            if (!isAdminUser) {
                // Load all attendance records
                await loadAllAttendanceRecords();
                
                // Check today's attendance
                await checkTodaysAttendance();

                // Calculate and display monthly statistics
                await calculateMonthlyStats();
                
                // Start enhanced location detection
                startEnhancedLocationDetection();
            }
        });

        // Enhanced location detection with multiple methods
        function startEnhancedLocationDetection() {
            const locationStatus = document.getElementById('locationStatus');
            locationStatus.innerHTML = '<div class="loading"></div> Starting enhanced location detection...';
            
            // Try GPS first with high accuracy
            useHighAccuracyGPS();
        }

        // High Accuracy GPS with multiple attempts
        function useHighAccuracyGPS() {
            const locationStatus = document.getElementById('locationStatus');
            
            if (!navigator.geolocation) {
                locationStatus.innerHTML = '<span style="color: red;">‚ùå Geolocation not supported</span>';
                useIPLocation();
                return;
            }

            locationStatus.innerHTML = '<div class="loading"></div> Using high accuracy GPS...';
            
            let attempts = 0;
            let bestPosition = null;
            
            // Clear previous watch
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
            
            locationWatchId = navigator.geolocation.watchPosition(
                async (position) => {
                    attempts++;
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Store best position
                    if (!bestPosition || accuracy < bestPosition.coords.accuracy) {
                        bestPosition = position;
                    }
                    
                    const distance = calculateDistance(userLat, userLng, COLLEGE_LOCATION.latitude, COLLEGE_LOCATION.longitude);
                    
                    // Determine accuracy level
                    let accuracyClass = 'accuracy-bad';
                    let accuracyText = 'Poor';
                    if (accuracy <= 20) {
                        accuracyClass = 'accuracy-good';
                        accuracyText = 'Good';
                    } else if (accuracy <= 50) {
                        accuracyClass = 'accuracy-poor';
                        accuracyText = 'Fair';
                    }
                    
                    locationStatus.innerHTML = `
                        <strong>GPS Location <span class="location-method">High Accuracy</span></strong><br>
                        <div class="location-coordinates">Lat: ${userLat.toFixed(6)}, Lng: ${userLng.toFixed(6)}</div>
                        <strong>Distance:</strong> ${distance.toFixed(2)} meters<br>
                        <strong>Accuracy:</strong> ${accuracy.toFixed(2)}m 
                        <span class="accuracy-indicator ${accuracyClass}">${accuracyText}</span>
                        <br><small>Attempt ${attempts}/5 - Waiting for better accuracy...</small>
                    `;
                    
                    // Check if we have good enough accuracy and are at college
                    if (accuracy <= ACCURACY_THRESHOLD) {
                        if (distance <= DISTANCE_THRESHOLD) {
                            locationStatus.className = 'location-status success';
                            locationStatus.innerHTML += '<br><span style="color: green;">‚úÖ You are at college!</span>';
                            
                            if (!attendanceMarkedToday) {
                                await markAttendanceAutomatically(userLat, userLng, accuracy, distance, 'high_accuracy_gps');
                            }
                            
                            // Stop watching
                            navigator.geolocation.clearWatch(locationWatchId);
                            return;
                        } else {
                            locationStatus.innerHTML += `<br><span style="color: orange;">üìç ${distance.toFixed(2)}m from college</span>`;
                        }
                    }
                    
                    // Stop after max attempts or if we have decent accuracy
                    if (attempts >= MAX_ATTEMPTS || accuracy <= 100) {
                        if (bestPosition && accuracy <= 100) {
                            const bestDistance = calculateDistance(
                                bestPosition.coords.latitude, 
                                bestPosition.coords.longitude, 
                                COLLEGE_LOCATION.latitude, 
                                COLLEGE_LOCATION.longitude
                            );
                            
                            if (bestDistance <= DISTANCE_THRESHOLD) {
                                locationStatus.className = 'location-status success';
                                locationStatus.innerHTML += '<br><span style="color: green;">‚úÖ Location confirmed - You are at college!</span>';
                                
                                if (!attendanceMarkedToday) {
                                    await markAttendanceAutomatically(
                                        bestPosition.coords.latitude, 
                                        bestPosition.coords.longitude, 
                                        bestPosition.coords.accuracy, 
                                        bestDistance, 
                                        'gps_optimized'
                                    );
                                }
                            } else {
                                locationStatus.innerHTML += `<br><span style="color: orange;">üìç Final reading: ${bestDistance.toFixed(2)}m from college</span>`;
                                showFallbackOptions();
                            }
                        } else {
                            locationStatus.innerHTML += '<br><span style="color: orange;">‚ö†Ô∏è Could not get accurate location</span>';
                            showFallbackOptions();
                        }
                        
                        navigator.geolocation.clearWatch(locationWatchId);
                    }
                },
                (error) => {
                    console.log('GPS error:', error);
                    locationStatus.innerHTML = `<span style="color: orange;">‚ö†Ô∏è GPS failed: ${error.message}</span>`;
                    useIPLocation();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
            
            // Fallback timeout
            setTimeout(() => {
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationStatus.innerHTML += '<br><span style="color: orange;">‚è∞ GPS timeout, trying alternative methods...</span>';
                    useIPLocation();
                }
            }, 30000);
        }

        // IP Location as fallback
        async function useIPLocation() {
            const locationStatus = document.getElementById('locationStatus');
            locationStatus.innerHTML += '<br><div class="loading"></div> Trying IP-based location...';
            
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (response.ok) {
                    const locationData = await response.json();
                    
                    const userLat = parseFloat(locationData.latitude);
                    const userLng = parseFloat(locationData.longitude);
                    const distance = calculateDistance(userLat, userLng, COLLEGE_LOCATION.latitude, COLLEGE_LOCATION.longitude);
                    
                    locationStatus.innerHTML = `
                        <strong>IP Location <span class="location-method">Network Based</span></strong><br>
                        <div class="location-coordinates">Lat: ${userLat.toFixed(6)}, Lng: ${userLng.toFixed(6)}</div>
                        <strong>City:</strong> ${locationData.city}, ${locationData.region}<br>
                        <strong>Distance:</strong> ${distance.toFixed(2)} meters<br>
                        <strong>ISP:</strong> ${locationData.org}
                    `;
                    
                    // For IP location, we're more lenient with distance
                    if (distance <= 2000) { // 2km radius for IP location
                        locationStatus.className = 'location-status success';
                        locationStatus.innerHTML += '<br><span style="color: green;">‚úÖ You are in Amreli area</span>';
                        
                        if (!attendanceMarkedToday) {
                            await markAttendanceAutomatically(userLat, userLng, 1000, distance, 'ip_location');
                        }
                    } else {
                        locationStatus.className = 'location-status warning';
                        locationStatus.innerHTML += `<br><span style="color: orange;">üìç ${(distance/1000).toFixed(1)}km from college</span>`;
                        showFallbackOptions();
                    }
                } else {
                    throw new Error('IP location failed');
                }
            } catch (error) {
                locationStatus.innerHTML += '<br><span style="color: orange;">‚ö†Ô∏è IP location failed</span>';
                showFallbackOptions();
            }
        }

        // Manual verification method
        async function markAttendanceWithVerification() {
            const locationStatus = document.getElementById('locationStatus');
            
            if (!attendanceMarkedToday) {
                locationStatus.innerHTML = '<div class="loading"></div> Verifying and marking attendance...';
                
                // Get current position for verification
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        });
                    });
                    
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    const distance = calculateDistance(userLat, userLng, COLLEGE_LOCATION.latitude, COLLEGE_LOCATION.longitude);
                    
                    let verificationMethod = 'manual_verification';
                    let verificationNote = '';
                    
                    if (distance <= DISTANCE_THRESHOLD) {
                        verificationNote = `Verified: ${distance.toFixed(2)}m from college`;
                    } else if (accuracy > 100) {
                        verificationNote = `Low accuracy (${accuracy.toFixed(2)}m) but manual confirmation`;
                        verificationMethod = 'manual_low_accuracy';
                    } else {
                        verificationNote = `Manual override - ${distance.toFixed(2)}m from college`;
                        verificationMethod = 'manual_override';
                    }
                    
                    await markAttendanceAutomatically(userLat, userLng, accuracy, distance, verificationMethod, verificationNote);
                    
                } catch (error) {
                    // Even if GPS fails, allow manual marking with note
                    await markAttendanceAutomatically(0, 0, 0, 0, 'manual_fallback', 'Location verification failed - manual entry');
                }
            }
        }

        // Show fallback options
        function showFallbackOptions() {
            document.getElementById('fallbackOption').style.display = 'block';
        }

        // Refresh location
        function refreshLocation() {
            document.getElementById('fallbackOption').style.display = 'none';
            startEnhancedLocationDetection();
        }

        // Calculate distance using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Mark attendance with enhanced data
        async function markAttendanceAutomatically(latitude, longitude, accuracy, distance, method, note = '') {
            try {
                const now = new Date();
                const attendanceData = {
                    userId: currentUser.uid,
                    email: currentUser.email,
                    fullName: userData?.fullName || 'Unknown',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    date: now.toISOString().split('T')[0],
                    time: now.toLocaleTimeString('en-IN', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }),
                    day: now.toLocaleDateString('en-IN', { weekday: 'long' }),
                    month: now.toLocaleDateString('en-IN', { month: 'long' }),
                    year: now.getFullYear(),
                    status: 'present',
                    location: {
                        latitude: latitude,
                        longitude: longitude,
                        accuracy: accuracy,
                        distance: distance,
                        method: method,
                        note: note
                    },
                    markedAutomatically: true
                };

                await db.collection('attendance').add(attendanceData);
                await loadAllAttendanceRecords();
                
                // Update UI
                document.getElementById('attendanceStatus').innerHTML = 
                    '<span style="color: green;">‚úÖ Attendance marked successfully!</span>';
                document.getElementById('attendanceTime').textContent = attendanceData.time;
                document.getElementById('attendanceDate').textContent = 
                    `${attendanceData.day}, ${attendanceData.date}`;
                document.getElementById('attendanceMethod').textContent = 
                    `${method.replace(/_/g, ' ').toUpperCase()} (${distance.toFixed(2)}m)`;
                document.getElementById('todayAttendance').style.display = 'block';
                
                attendanceMarkedToday = true;
                await calculateMonthlyStats();
                
                // Hide fallback options
                document.getElementById('fallbackOption').style.display = 'none';
                
            } catch (error) {
                console.error('Error marking attendance:', error);
                document.getElementById('attendanceStatus').innerHTML = 
                    '<span style="color: red;">‚ùå Error marking attendance</span>';
            }
        }

        // [Rest of the functions remain the same - loadUserData, checkAdminStatus, etc.]
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    document.getElementById('userName').textContent = userData.fullName || 'Not set';
                    document.getElementById('userPhone').textContent = userData.phone || 'Not set';
                } else {
                    await db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'active'
                    }, { merge: true });
                    document.getElementById('userName').textContent = 'Not set';
                    document.getElementById('userPhone').textContent = 'Not set';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('userName').textContent = 'Error loading';
                document.getElementById('userPhone').textContent = 'Error loading';
            }
        }

        async function checkAdminStatus() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    isAdminUser = userData.role === 'admin';
                    if (isAdminUser) {
                        document.getElementById('regularDashboard').style.display = 'none';
                        document.getElementById('adminPanelBtn').style.display = 'inline-block';
                        await loadAllStudents();
                    }
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        async function loadAllAttendanceRecords() {
            try {
                const attendanceQuery = await db.collection('attendance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                allAttendanceRecords = [];
                attendanceQuery.forEach(doc => {
                    allAttendanceRecords.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                allAttendanceRecords.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA;
                });

            } catch (error) {
                console.error('Error loading attendance records:', error);
            }
        }

        async function checkTodaysAttendance() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayRecord = allAttendanceRecords.find(record => record.date === today);
                
                if (todayRecord) {
                    document.getElementById('attendanceStatus').innerHTML = 
                        '<span style="color: green;">‚úÖ Attendance already marked for today</span>';
                    document.getElementById('attendanceTime').textContent = todayRecord.time;
                    document.getElementById('attendanceDate').textContent = 
                        `${todayRecord.day}, ${todayRecord.date}`;
                    document.getElementById('attendanceMethod').textContent = 
                        `${todayRecord.location.method.replace(/_/g, ' ').toUpperCase()}`;
                    document.getElementById('todayAttendance').style.display = 'block';
                    attendanceMarkedToday = true;
                }
            } catch (error) {
                console.error('Error checking attendance:', error);
            }
        }

        async function calculateMonthlyStats() {
            try {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const monthRecords = allAttendanceRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === currentMonth && 
                           recordDate.getFullYear() === currentYear;
                });
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                let workingDays = 0;
                
                for (let day = new Date(firstDay); day <= lastDay; day.setDate(day.getDate() + 1)) {
                    if (day.getDay() !== 0 && day.getDay() !== 6) {
                        workingDays++;
                    }
                }
                
                const presentDays = monthRecords.length;
                const absentDays = Math.max(0, workingDays - presentDays);
                const percentage = workingDays > 0 ? ((presentDays / workingDays) * 100).toFixed(1) : 0;
                
                document.getElementById('monthWorkingDays').textContent = workingDays;
                document.getElementById('monthPresent').textContent = presentDays;
                document.getElementById('monthAbsent').textContent = absentDays;
                document.getElementById('monthPercentage').textContent = percentage + '%';
                
                generateCalendarView(currentMonth, currentYear, monthRecords);
                
            } catch (error) {
                console.error('Error calculating monthly stats:', error);
            }
        }

        function generateCalendarView(month, year, records) {
            const calendarDiv = document.getElementById('monthCalendar');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            let calendarHTML = '<div class="calendar">';
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day calendar-day-header">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isPresent = records.some(record => record.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                const isWeekend = new Date(year, month, day).getDay() === 0 || 
                                 new Date(year, month, day).getDay() === 6;
                
                let dayClass = 'calendar-day';
                if (isPresent) dayClass += ' present';
                else if (!isWeekend && day <= new Date().getDate()) dayClass += ' absent';
                
                calendarHTML += `<div class="${dayClass}">${day}${isToday ? ' üìç' : ''}</div>`;
            }
            
            calendarHTML += '</div>';
            calendarDiv.innerHTML = calendarHTML;
        }

        // Other functions...
        function viewProfile() {
            alert('Profile view functionality');
        }

        function viewAttendanceRecords() {
            alert('Attendance records functionality');
        }

        function logout() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
            if (auth) {
                auth.signOut().then(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                });
            } else {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        function openAdminPanel() {
            alert('Admin panel functionality');
        }
    </script>
</body>
</html>